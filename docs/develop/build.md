# Сборка прошивки# Build Process


Процесс сборки контролируется [platformio.ini](https://github.com/SSVC0059/ssvc_open_connect/blob/main/platformio.ini) и автоматизирует сборку внешнего веб-сайта с помощью Vite, а также бинарную компиляцию для прошивки ESP32. Всякий раз, когда PlatformIO собирает новый бинарный файл, она вызывает скрипт Python build_interface.py. Он проверяет файлы внешнего интерфейса на наличие изменений. При необходимости он запускает сборку Vite и сжимает полученные файлы в формате gzip либо в каталоге data/, либо встраивает их в заголовочный файл. 

## Изменение менеджера пакетов JS

В этом проекте в качестве менеджера пакетов по умолчанию используется NPM. Однако у многих пользователей могут быть другие предпочтения, и они предпочтут использовать YARN или PNPM. Просто переключите интерфейс на один из других менеджеров пакетов. Скрипт сборки определяет менеджер пакетов по наличию его файла блокировки и соответствующим образом запускает процесс сборки vite.

## Использование Flash или встраивание в двоичный файл

Внешний веб-сайт может работать либо из раздела LITTLEFS на флэш-накопителе, либо быть встроенным в двоичный файл прошивки (по умолчанию). Преимущество второго варианта в том, что нужно распространять только один двоичный файл, что упрощает процесс OTA. Кроме того, это желательно, если вы хотите сохранить настройки, хранящиеся в разделе LITTLEFS, или другие файлы, которые должны пережить обновление прошивки. Чтобы использовать раздел LITTLEFS, закомментируйте следующий флаг сборки

```ini
build_flags =
    ...
    -D EMBED_WWW
```

## Выбор функций

Многие встроенные функции фреймворка можно включать и отключать по мере необходимости во время компиляции. Это может помочь сэкономить место в скетче и памяти, если вашему проекту не нужен полный набор функций. Функции управления точкой доступа и Wi-Fi являются "основными функциями" и всегда включены. Выбор функций можно контролировать с помощью флагов сборки, указанных в [features.ini](https://github.com/SSVC0059/ssvc_open_connect/blob/main/features.ini).

Настройте параметры по своему усмотрению. Значение 0 отключит указанную функцию.:

```ini
  -D FT_SECURITY=1
  -D FT_MQTT=1
  -D FT_NTP=1
  -D FT_UPLOAD_FIRMWARE=1
  -D FT_DOWNLOAD_FIRMWARE=1
  -D FT_SLEEP=1
  -D FT_BATTERY=1
  -D FT_ETHERNET=1
```

| Flag                 | Description                                                                                                                                                                                                              |
| -------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| FT_SECURITY          | Определяет, включены ли функции безопасности. Если отключить эту функцию, вам не нужно будет проходить аутентификацию для доступа к устройству, и все предикаты аутентификации будут проигнорированы. |
| FT_MQTT              | Определяет, включены ли функции MQTT. Отключите эту функцию, если вашему проекту не требуется поддержка MQTT.                                                                                                              |
| FT_NTP               | Определяет, включены ли функции синхронизации сетевого протокола времени. Отключите эту функцию, если вашему проекту не требуется точное время.                                                                                |
| FT_UPLOAD_FIRMWARE   | Определяет, включена ли функция ручной загрузки прошивки. Отключите эту функцию, если вы не будете загружать прошивку вручную.                                                                                                |
| FT_DOWNLOAD_FIRMWARE | Определяет, включена ли функция загрузки прошивки. Отключите эту функцию, если не хотите, чтобы прошивка загружалась с сервера.                                                                                                      |
| FT_SLEEP             | Определяет, включена ли функция глубокого сна. Отключите эту функцию, если ваше устройство не работает от аккумулятора или вам не нужно переводить его в режим глубокого сна для экономии энергии.                                                      |
| FT_BATTERY           | Определяет, следует ли сообщать клиентам о состоянии заряда батареи. Отключите эту функцию, если ваше устройство не работает от аккумулятора.                                                                                      |
| FT_ETHERNET          | Controls whether an ethernet interface will be used. Disable this if your device has no ethernet interface connected.                                                                                      |

Кроме того, пользовательские функции могут быть добавлены или удалены во время выполнения. 

## Заводские настройки

Платформа имеет встроенные заводские настройки, которые используются в качестве значений по умолчанию для различных настраиваемых сервисов, где настройки не сохраняются в файловой системе. Эти настройки можно изменить с помощью флагов сборки, указанных в [factory_settings.ini](https://github.com/SSVC0059/ssvc_open_connect/blob/main/factory_settings.ini). Все вводимые здесь строки должны быть экранированы, особенно специальные символы.

Настройте параметры по своему усмотрению. Например, вы можете настроить домашнюю сеть Wi-Fi в соответствии с заводскими настройками по умолчанию:

```ini
  -D FACTORY_WIFI_SSID=\"My\ Awesome\ WiFi\ Network\"
  -D FACTORY_WIFI_PASSWORD=\"secret\"
  -D FACTORY_WIFI_HOSTNAME=\"ssvcOpenConnect\"
```

### Настройки точки доступа по умолчанию

По умолчанию заводские настройки устройства предусматривают создание точки доступа при запуске, которую можно использовать для настройки устройства:

- SSID: SsvcOpenConnect
- Password: open-connect

### Настройки безопасности и учётные данные пользователя

По умолчанию заводские настройки предусматривают создание двух учётных записей пользователей со следующими учётными данными:

| Имя пользователя | Пароль |
| -------- | -------- |
| admin    | admin    |
| guest    | guest    |

Для лучшей защиты устройства рекомендуется изменить учетные данные пользователя по умолчанию. Это можно сделать в пользовательском интерфейсе или изменив [factory_settings.ini](https://github.com/SSVC0059/ssvc_open_connect/blob/main/factory_settings.ini), как упоминалось выше.

### Настройка заводского часового пояса

Изменение настроек часового пояса на заводе — распространённая необходимость. Это требует некоторых усилий, поскольку название часового пояса и формат POSIX на данный момент хранятся как отдельные значения. Названия часовых поясов и форматы POSIX содержатся в коде пользовательского интерфейса в [timezones.ts](https://github.com/SSVC0059/ssvc_open_connect/blob/main/interface/src/routes/connections/ntp/timezones.ts). Возьмите оттуда подходящую пару значений, например, для Лос-Анджелеса нужно использовать:

```ini
  -D FACTORY_NTP_TIME_ZONE_LABEL=\"Europe/Moscow\"
  -D FACTORY_NTP_TIME_ZONE_FORMAT=\"PST8PDT,M3.2.0,M11.1.0\"
```

## Другие флаги сборки

### Совместное использование ресурсов из разных источников

Если вам нужно включить совместное использование ресурсов из разных источников (CORS) на сервере ESP32, просто раскомментируйте следующие флаги сборки:

```ini
build_flags =
...
  ; Uncomment to configure Cross-Origin Resource Sharing
  -D ENABLE_CORS
  -D CORS_ORIGIN=\"*\"
```

Это добавит заголовки `Access-Control-Allow-Origin` and `Access-Control-Allow-Credentials` к любому отправленному запросу.

### ESP32 `CORE_DEBUG_LEVEL`

Ядро ESP32 Arduino и многие другие библиотеки используют инструменты ведения журнала ESP. Чтобы включить эти сообщения об отладке и ошибках, генерируемые глубоко внутри ваших библиотек, раскомментируйте следующий флаг сборки.

```ini
build_flags =
...
	-D CORE_DEBUG_LEVEL=5
```

Он принимает значения от 5 (подробно) до 1 (ошибки) для разной глубины вывода информации на последовательный терминал. Если этот параметр закомментирован, отладочные сообщения из основных библиотек отображаться не будут. Для рабочей сборки этот параметр следует закомментировать.

### Serve Config Files

Если включить этот флаг сборки, ESP32 будет обслуживать все конфигурационные файлы, хранящиеся во флэш-разделе LittleFS, в папке http:\\[IP]\config\[filename].json. Это может быть полезно для устранения неполадок. Однако настоятельно рекомендуется отключать эту функцию в рабочих сборках.

```ini
build_flags =
...
  -D SERVE_CONFIG_FILES
```

### Информация о последовательной связи

В некоторых случаях может быть полезно не выводить никакую информацию на последовательный консоль (Serial1 или USB CDC). Если закомментировать следующий флаг сборки, ESP32-Sveltekit не будет выводить никакую информацию на последовательную консоль.

```ini
build_flags =
...
  -D SERIAL_INFO
```

## Хранилище корневых сертификатов SS

Для некоторых функций, таких как загрузка прошивки или использование клиента MQTT, требуется SSL-соединение. Для этого ESP32 должен знать сертификат корневого центра сертификации SSL. Система сборки содержит скрипт на Python, созданный на основе Espressif ESP-IDF, для создания хранилища сертификатов, содержащего один или несколько сертификатов. Чтобы создать хранилище, необходимо раскомментировать три строки ниже в platformio.ini.

```ini
extra_scripts =
    pre:scripts/generate_cert_bundle.py
board_build.embed_files = src/certs/x509_crt_bundle.bin
board_ssl_cert_source = adafruit
```

Скрипт загрузит общедоступное хранилище сертификатов из Mozilla (board_ssl_cert_source = mozilla) или репозитория, курируемого Adafruit (board_ssl_cert_source = adafruit) или (board_ssl_cert_source = adafruit-full), создаст двоичный файл, содержащий все сертификаты, и встроит его в прошивку. Это добавит в образ прошивки около 65 КБ. Если вам нужно всего несколько известных сертификатов, вы можете поместить их *.pem или *.der файлы в папку ssl_certs и изменить board_ssl_cert_source = folder. Тогда в хранилище будут включены только эти сертификаты. Это особенно полезно, если вам нужно подключиться только к известным серверам и уменьшить размер образа прошивки на несколько килобайт:

!!! info

     Для включения SSL необходимо также включить функцию `FT_NTP=1`

!!! bug

    В данный момент при загрузке прошивки, например, с Github, возникает ошибка с пакетом сертификатов. С помощью флага сборки -D DOWNLOAD_OTA_SKIP_CERT_VERIFY можно отключить проверку сертификата, чтобы OTA продолжал работать. Похоже, это влияет только на OTA, а не на MQTT. Имейте в виду, что это лишает SSL основной функции безопасности и позволяет проводить атаки типа «человек посередине».

## Ограничение в 32 символа для Vite и LittleFS

Статические файлы для веб-сайта создаются с помощью vite. По умолчанию vite добавляет уникальное хэш-значение ко всем именам файлов для повышения эффективности кэширования. Однако LittleFS на ESP32 поддерживает только имена файлов длиной до 32 символов. Это ограничивает количество символов, доступных пользователю для именования файлов Svelte. Чтобы немного расширить возможности, плагин vite удаляет все хэш-значения, поскольку на ESP32 они бесполезны. Однако при именовании файлов помните об ограничении в 32 символа. Слишком длинные имена могут вызвать некоторые проблемы при сборке двоичного файла LittleFS.

## Объединённый файл прошивки для веб-флэшера

Система сборки PIO вызывает скрипт merge_bin.py для создания объединённого двоичного файла прошивки, готового к использованию с веб-инструментами ESP. Файл находится в папке сборки PIO. Обычно build/merged/{APP_NAME}_{$PIOENV}_{APP_VERSION}.bin.
