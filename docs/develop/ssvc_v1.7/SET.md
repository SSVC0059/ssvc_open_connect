## SSVC0059_V2 UART API — команда `SET`

Документация по синтаксису команды `SET`.

Команда `SET` используется для задания различных настроек. Команда работает во всех режимах, когда контроллер принимает запросы по UART.

Максимальная длина строки — 300 символов, включая завершающие строку `\n` и нулевой символ.

### Общий формат команды

```text
SET <параметр1>=<значение1>,<параметр2>=<значение2>,...,<параметрN>=<значениеN>
```

### Перечень принимаемых параметров

Поддерживается всеми версиями прошивок 2.2.* и 2.3.* (если не указано иное):

- `heads=[<время_включения>,<период>]` — скорость отбора голов.
- `hearts=[<время_включения>,<период>]` — скорость отбора тела.
- `hyst=<значение>` — гистерезис.
- `decrement=<значение>` — декремент.
- `formula=[0|1]` — формула.
- `tank_mmhg=<значение>` — давление в кубе относительно атмосферного (параметр в настройках), мм рт. ст.
- `tank_mmhg_act=<значение>` — актуальное давление в кубе относительно атмосферного (измеряется датчиком), мм рт. ст.
- `heads_timer=<время>` — время отбора голов.
- `hearts_timer=<время>` — таймер фиксации температуры отбора тела.
- `start_delay=<время>` — отложенный пуск.
- `hearts_finish_temp=<температура>` — температура завершения отбора тела.
- `formula_start_temp=<температура>` — начальная температура для формулы.
- `valve_bw=[<скорость1>,<скорость2>,<скорость3>]` — пропускные способности клапанов в мл/ч.
- `tails=[<значение1>,<значение2>]` — скорость отбора хвостов (актуально для firmware 2.2.*).
- `tails_temp=<температура>` — температура завершения отбора хвостов (актуально для firmware 2.2.*).
- `late_heads=[<время_включения>,<период>]` — скорость отбора подголовников (актуально для firmware 2.3.*).
- `late_heads_timer=<значение>` — время отбора подголовников, с (кратно 300 с; актуально для firmware 2.3.*).
- `parallel=[<время_включения>,<период>]` — параллельный отбор клапаном 3 (актуально для firmware 2.3.*).
- `parallel_v1=[<время_включения>,<период>]` — параллельный отбор клапаном 1 (актуально для firmware 2.2.*).
- `parallel_v3=[[<температура>,<время_включения>,<период>], …]` — параллельный отбор клапаном 3 (актуально для firmware 2.2.*).
- `release_speed=<значение>` — скорость сброса (время открытого клапана); актуально с опцией «Сброс и снижение».
- `release_timer=<время>` — время сброса, с; актуально с опцией «Сброс и снижение».
- `heads_final=<значение>` — скорость отбора к окончанию голов; актуально с опцией «Сброс и снижение».

Дополнительно есть оперативные параметры текущего этапа:

- `s_temp=<температура>` — температура, °C (1 знак после запятой, максимум 110.0).
- `s_hyst=<гистерезис>` — гистерезис, °C (2 знака после запятой, от 0.06 до 50.06).
- `s_speed=[<время_включения>,<период>]` — скорость отбора (аналогична `heads`).
- `s_decrement=<декремент>` — декремент, %, целое число до 100.
- `s_timer=<время>` — таймер, с; целое число до 86400.

---

## Описание параметров

### `heads`, `late_heads`, `hearts`, `tails`, `s_speed`, `parallel_v1`, `parallel`

Настройки скорости отбора (время открытого клапана и период цикла).

- **Назначение**:
  - `heads` — головы;
  - `hearts` — тело;
  - `late_heads` — подголовники;
  - `tails` — хвосты;
  - `s_speed` — оперативные параметры;
  - `parallel_v1` — параллельный отбор клапаном 1 (firmware 2.2.*);
  - `parallel` — параллельный отбор клапаном 3 (firmware 2.3.*).

- **Синтаксис**:

  ```text
  heads=[<время_включения>,<период>]
  ```

  - `<время_включения>` — вещественное число с одной десятичной цифрой (например, `99.0`).
  - `<период>` — целое число.

- **Ограничения**:
  - `время_включения ≤ 99.9`
  - `период ≤ 999`
  - `время_включения ≤ период`

- **Пример**:

  ```text
  heads=[99.0,100]
  ```

### `hyst`

- **Описание**: устанавливает значение гистерезиса.
- **Синтаксис**:

  ```text
  hyst=<значение>
  ```

  - `<значение>` — число с двумя знаками после запятой (например, `0.25`).

- **Ограничения**:
  - положительное число, не более `50.0`.

- **Пример**:

  ```text
  hyst=0.25
  ```

### `decrement`

- **Описание**: устанавливает величину в процентах, на которую будет уменьшаться скорость отбора тела при «злете» температуры.
- **Синтаксис**:

  ```text
  decrement=<значение>
  ```

  - `<значение>` — целое число (например, `20`).

- **Ограничения**:
  - целое положительное число от `0` до `100` включительно.

- **Пример**:

  ```text
  decrement=20
  ```

### `formula`

- **Описание**: использовать или нет формулу для снижения скорости отбора тела в зависимости от температуры на ТД2.
- **Синтаксис**:

  ```text
  formula=[0|1]
  ```

  - `0` — не использовать формулу;
  - `1` — использовать.

- **Пример**:

  ```text
  formula=1
  ```

### `tank_mmhg`

- **Описание**: устанавливает давление в кубе в миллиметрах ртутного столба (мм рт. ст.) относительно атмосферного.
- **Синтаксис**:

  ```text
  tank_mmhg=<значение>
  ```

  - `<значение>` — целое число (например, `30`).

- **Ограничения**:
  - значение от `0` до `50`.

- **Пример**:

  ```text
  tank_mmhg=50
  ```

### `tank_mmhg_act`

- **Назначение**: передача актуальных (динамических) показаний датчика давления в систему расчетов.  
  Если датчик в кубе отсутствует и данные не передаются, контроллер использует статическое значение из `tank_mmhg`.

- **Описание**: устанавливает давление в кубе в мм рт. ст. относительно атмосферного. Имеет приоритет над `tank_mmhg`.  
  Если контроллер получил `tank_mmhg_act` хотя бы раз, он будет использовать это значение (и игнорировать последующие изменения `tank_mmhg`) до момента выключения питания.

- **Синтаксис**:

  ```text
  tank_mmhg_act=<значение>
  ```

  - `<значение>` — вещественное число с одной десятичной цифрой (например, `30.0`).

- **Ограничения**:
  - значение от `0.0` до `50.0`.

- **Пример**:

  ```text
  tank_mmhg_act=45.5
  ```

### `heads_timer`

- **Описание**: таймер отбора голов (время в секундах).
- **Синтаксис**:

  ```text
  heads_timer=<время>
  ```

  - `<время>` — целое число (например, `36000`).

- **Ограничения**:
  - положительное число, не более `86400`, кратное `300` (5 минут).

- **Пример**:

  ```text
  heads_timer=36000
  ```

### `late_heads_timer`

- **Описание**: таймер отбора подголовников (время в секундах).
- **Синтаксис**:

  ```text
  late_heads_timer=<время>
  ```

  - `<время>` — целое число (например, `36000`).

- **Ограничения**:
  - положительное число, не более `86400`, кратное `300`.

- **Пример**:

  ```text
  late_heads_timer=36000
  ```

### `hearts_timer`

- **Описание**: таймер фиксации температуры отбора тела, мин.
- **Синтаксис**:

  ```text
  hearts_timer=<время>
  ```

  - `<время>` — целое число (например, `10`).

- **Ограничения**:
  - положительное число, не более `30`.

- **Пример**:

  ```text
  hearts_timer=30
  ```

### `tails_temp`

- **Описание**: температура завершения отбора хвостов, °C.
- **Синтаксис**:

  ```text
  tails_temp=<температура>
  ```

  - `<температура>` — число с плавающей точкой (например, `109.9`).

- **Ограничения**:
  - положительное число, не более `110.0`.

- **Пример**:

  ```text
  tails_temp=109.9
  ```

### `start_delay`

- **Описание**: отложенный пуск (время в секундах).
- **Синтаксис**:

  ```text
  start_delay=<время>
  ```

  - `<время>` — целое число (например, `6000`).

- **Ограничения**:
  - положительное число, не более `18000`.

- **Пример**:

  ```text
  start_delay=18000
  ```

### `hearts_finish_temp`

- **Описание**: температура на ТД2, при которой завершается отбор тела, °C.
- **Синтаксис**:

  ```text
  hearts_finish_temp=<температура>
  ```

  - `<температура>` — число с плавающей точкой (например, `93.0`).

- **Ограничения**:
  - положительное число, не более `110.0`.

- **Пример**:

  ```text
  hearts_finish_temp=93.0
  ```

### `formula_start_temp`

- **Описание**: начальная температура для начала работы формулы, °C.
- **Синтаксис**:

  ```text
  formula_start_temp=<температура>
  ```

  - `<температура>` — число с плавающей точкой (например, `84.0`).

- **Ограничения**:
  - температура от `84.0` до `100.0` включительно.

- **Пример**:

  ```text
  formula_start_temp=84.0
  ```

### `valve_bw`

- **Описание**: пропускные способности клапанов в мл/ч.
- **Синтаксис**:

  ```text
  valve_bw=[<скорость1>,<скорость2>,<скорость3>]
  ```

  - каждая `<скоростьN>` — целое число.

- **Ограничения**:
  - все скорости `≤ 20000`.

- **Пример**:

  ```text
  valve_bw=[10000,20000,15000]
  ```

### `parallel_v3`

- **Описание**: устанавливает параметры параллельного отбора клапаном 3 на этапе отбора тела (актуально для прошивок 2.2.*).  
  Задается 4 диапазона, в каждом диапазоне передаются три значения.

- **Синтаксис**:

  ```text
  parallel_v3=[[<температура>,<время_включения>,<период>],
               [<температура>,<время_включения>,<период>],
               [<температура>,<время_включения>,<период>],
               [<температура>,<время_включения>,<период>]]
  ```

  - `<температура>` — начало диапазона, вещественное число с одной десятичной цифрой (например, `84.0`).  
    (Первый диапазон всегда начинается с `0.0`; полученное значение температуры в первом диапазоне игнорируется.)
  - `<время_включения>` — вещественное число с одной десятичной цифрой (например, `99.0`).
  - `<период>` — целое число.

- **Ограничения**:
  - `время_включения < период`
  - `температура ≤ 99.9`
  - `время_включения ≤ 99.9`
  - `период ≤ 999`

- **Пример**:

  ```text
  SET parallel_v3=[[0.0,0.4,10],[81.1,0.5,50],[86.2,0.6,50],[96.3,1.1,100]]
  ```

### `release_speed`

- **Описание**: скорость сброса (время открытого клапана), с; актуально с опцией «Сброс и снижение».
- **Синтаксис**:

  ```text
  release_speed=<время_включения>
  ```

  - `<время_включения>` — вещественное число с одной десятичной цифрой (например, `99.0`).

- **Ограничения**:
  - `время_включения ≤ 99.9`.

- **Примечание**: значение должно быть меньше периода этапа отбора голов (контроль возлагается на передающую сторону).

- **Пример**:

  ```text
  release_speed=99.0
  ```

### `release_timer`

- **Описание**: время сброса, с. Включается опция «Сброс и снижение» при значении больше `0`.
- **Синтаксис**:

  ```text
  release_timer=<время>
  ```

  - `<время>` — целое число (например, `600`).

- **Ограничения**:
  - положительное число, не более `1200` (20 минут).

- **Пример**:

  ```text
  release_timer=600
  ```

### `heads_final`

- **Описание**: скорость отбора к окончанию голов, с. Включается опция «Сброс и снижение» при любом значении.
- **Синтаксис**:

  ```text
  heads_final=<время_включения>
  ```

  - `<время_включения>` — вещественное число с одной десятичной цифрой (например, `10.5`).

- **Ограничения**:
  - `время_включения ≤ 99.9`.

- **Примечание**: значение должно быть меньше периода этапа отбора голов (контроль возлагается на передающую сторону).

- **Пример**:

  ```text
  heads_final=10.5
  ```

---

## Проверка на ошибки

- При неверном формате или несоответствии ограничениям возвращается сообщение об ошибке.

  **Пример**:

  ```json
  {"type": "response","request": "SET heads=[1,2]","result": "error: heads=[1,2]"}
  ```

- Для неизвестных параметров возвращается сообщение об ошибке.

  **Пример**:

  ```json
  {"type": "response","request": "ABCD","result": "unknown"}
  ```

---

## Примеры корректных команд

```text
SET heads=[30.0,180],hearts=[2.5,5],formula=1
SET heads=[60.0,360],hearts=[2.0,4],hyst=0.19,formula=0
SET heads=[20.5,245],hearts=[1.5,3],hyst=0.25,decrement=20,formula=1,tank_mmhg=50,heads_timer=36000,hearts_timer=30,start_delay=18000,hearts_finish_temp=93.0,formula_start_temp=84.0,valve_bw=[10000,11000,12000]
SET formula=1
SET formula=0
SET tank_mmhg=50
SET heads_timer=36000
SET heads_timer=86400
SET hearts_timer=30
SET start_delay=18000
SET hearts_finish_temp=110.0
SET formula_start_temp=84.0
SET formula_start_temp=100.0
SET valve_bw=[10000,11000,12000]
```

## Примеры команд с ошибками

```text
SET heads=[60.0,360],hearts=[2.0,4],hyst=0.19,decrement=30,formula=2
SET heads=[100.0,180],hearts=[2.5,5],formula=1
SET heads=[99.9,1000],hearts=[2.5,5]
SET heads=[99.1,99],hearts=[2.5,5],formula=1
SET hyst=50.01
SET decrement=101
SET tank_mmhg=51
SET heads_timer=86401
SET hearts_timer=31
SET start_delay=18001
SET hearts_finish_temp=110.1
SET formula_start_temp=83.9
SET formula_start_temp=100.1
SET valve_bw=[10000,11000,21000]
```


